name: ì´ìŠˆ ìë™ ë¼ë²¨ë§

on:
  issues:
    types: [opened, reopened, edited]

jobs:
  label:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì´ìŠˆ ë‚´ìš© ë¶„ì„ ë° ë¼ë²¨ ê²°ì •
      id: label-analysis
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const title = issue.title.toLowerCase();
          const body = (issue.body || '').toLowerCase();
          const author = issue.user.login;
          
          let labels = new Set();
          
          // ì´ìŠˆ íƒ€ì…ë³„ ë¼ë²¨ ê·œì¹™
          const typeRules = {
            'bug': {
              keywords: ['bug', 'error', 'issue', 'problem', 'fail', 'crash', 'broken', 'ë²„ê·¸', 'ì˜¤ë¥˜', 'ë¬¸ì œ', 'ì‹¤íŒ¨', 'ê³ ì¥'],
              label: 'bug'
            },
            'feature': {
              keywords: ['feature', 'enhancement', 'improve', 'add', 'implement', 'ê¸°ëŠ¥', 'ê°œì„ ', 'ì¶”ê°€', 'êµ¬í˜„'],
              label: 'feature'
            },
            'documentation': {
              keywords: ['doc', 'document', 'readme', 'guide', 'manual', 'ë¬¸ì„œ', 'ì„¤ëª…', 'ê°€ì´ë“œ', 'ë§¤ë‰´ì–¼'],
              label: 'documentation'
            },
            'question': {
              keywords: ['question', 'help', 'how', 'why', 'what', 'ì§ˆë¬¸', 'ë„ì›€', 'ì–´ë–»ê²Œ', 'ì™œ', 'ë¬´ì—‡'],
              label: 'question'
            },
            'security': {
              keywords: ['security', 'vulnerability', 'cve', 'attack', 'breach', 'exploit', 'ë³´ì•ˆ', 'ì·¨ì•½ì ', 'ê³µê²©'],
              label: 'security'
            },
            'performance': {
              keywords: ['performance', 'slow', 'speed', 'fast', 'optimize', 'memory', 'ì„±ëŠ¥', 'ëŠë¦¼', 'ì†ë„', 'ìµœì í™”'],
              label: 'performance'
            },
            'ui-ux': {
              keywords: ['ui', 'ux', 'design', 'interface', 'layout', 'style', 'ë””ìì¸', 'ì¸í„°í˜ì´ìŠ¤', 'í™”ë©´'],
              label: 'ui/ux'
            }
          };

          // ìš°ì„ ìˆœìœ„ ë¼ë²¨ ê·œì¹™
          const priorityRules = {
            'critical': {
              keywords: ['critical', 'urgent', 'emergency', 'breaking', 'down', 'crash', 'ê¸´ê¸‰', 'í¬ë¦¬í‹°ì»¬', 'ì¤‘ë‹¨', 'ì¶©ëŒ'],
              label: 'priority: critical'
            },
            'high': {
              keywords: ['high', 'important', 'serious', 'major', 'ë†’ìŒ', 'ì¤‘ìš”', 'ì‹¬ê°'],
              label: 'priority: high'
            },
            'low': {
              keywords: ['low', 'minor', 'trivial', 'nice-to-have', 'ë‚®ìŒ', 'ì‚¬ì†Œ', 'ë¯¸ë¯¸'],
              label: 'priority: low'
            }
          };

          // ì˜ì—­ë³„ ë¼ë²¨ ê·œì¹™
          const areaRules = {
            'backend': {
              keywords: ['api', 'backend', 'server', 'database', 'db', 'auth', 'login', 'ë°±ì—”ë“œ', 'ì„œë²„', 'ë°ì´í„°ë² ì´ìŠ¤'],
              label: 'area: backend'
            },
            'frontend': {
              keywords: ['frontend', 'ui', 'component', 'css', 'html', 'react', 'vue', 'í”„ë¡ íŠ¸ì—”ë“œ', 'í™”ë©´'],
              label: 'area: frontend'
            },
            'agent': {
              keywords: ['ai', 'agent', 'chatbot', 'llm', 'gpt', 'model', 'inference', 'ì—ì´ì „íŠ¸', 'ì±—ë´‡'],
              label: 'area: agent'
            },
            'infrastructure': {
              keywords: ['deploy', 'deployment', 'ci', 'cd', 'docker', 'kubernetes', 'infra', 'ë°°í¬', 'ì¸í”„ë¼'],
              label: 'area: infrastructure'
            },
            'testing': {
              keywords: ['test', 'testing', 'unit', 'integration', 'e2e', 'coverage', 'í…ŒìŠ¤íŠ¸', 'ê²€ì¦'],
              label: 'area: testing'
            }
          };

          // ìƒíƒœ ë¼ë²¨ ê·œì¹™
          const statusRules = {
            'needs-reproduction': {
              keywords: ['cannot reproduce', 'need steps', 'need info', 'ì¬í˜„ ë¶ˆê°€', 'ì •ë³´ í•„ìš”'],
              label: 'status: needs-reproduction'
            },
            'duplicate': {
              keywords: ['duplicate', 'duplicated', 'same as', 'ì¤‘ë³µ', 'ê°™ì€ ë¬¸ì œ'],
              label: 'duplicate'
            },
            'wontfix': {
              keywords: ['wont fix', 'will not fix', 'by design', 'ìˆ˜ì • ì•ˆí•¨', 'ì„¤ê³„ìƒ'],
              label: 'wontfix'
            }
          };

          // ë‚œì´ë„ ë¼ë²¨ ê·œì¹™
          const difficultyRules = {
            'good first issue': {
              keywords: ['beginner', 'easy', 'simple', 'first time', 'ì´ˆë³´ì', 'ì‰¬ìš´', 'ê°„ë‹¨í•œ'],
              label: 'good first issue'
            },
            'help wanted': {
              keywords: ['help wanted', 'help needed', 'community', 'ë„ì›€ í•„ìš”', 'ì»¤ë®¤ë‹ˆí‹°'],
              label: 'help wanted'
            }
          };

          // ê° ê·œì¹™ ì ìš©
          const allRules = {
            ...typeRules,
            ...priorityRules,
            ...areaRules,
            ...statusRules,
            ...difficultyRules
          };

          for (const [ruleName, rule] of Object.entries(allRules)) {
            if (rule.keywords.some(keyword => title.includes(keyword) || body.includes(keyword))) {
              labels.add(rule.label);
            }
          }

          // ì‹ ê·œ ê¸°ì—¬ì í™•ì¸
          const { data: userIssues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            creator: author,
            state: 'all'
          });

          const isNewContributor = userIssues.length <= 1;
          if (isNewContributor) {
            labels.add('new contributor');
          }

          // ì´ìŠˆ ë²ˆí˜¸ë‚˜ ì œëª© íŒ¨í„´ ê¸°ë°˜ ë¼ë²¨
          const issueNumber = issue.number;
          if (issueNumber <= 50) {
            labels.add('early issue');
          }

          // ì œëª© ê¸¸ì´ ê¸°ë°˜
          if (title.length < 20) {
            labels.add('needs-detail');
          }

          // ë³¸ë¬¸ì´ ì—†ê±°ë‚˜ ë§¤ìš° ì§§ì€ ê²½ìš°
          if (!body || body.trim().length < 50) {
            labels.add('needs-detail');
          }

          // í…œí”Œë¦¿ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
          const hasTemplate = body.includes('##') || body.includes('###') || body.includes('**');
          if (!hasTemplate) {
            labels.add('no-template');
          }

          // ì™¸ë¶€ ë§í¬ë‚˜ ì°¸ì¡°ê°€ ìˆëŠ” ê²½ìš°
          if (body.includes('http') || body.includes('github.com') || body.includes('stackoverflow')) {
            labels.add('external-reference');
          }

          // ì½”ë“œ ë¸”ë¡ì´ ìˆëŠ” ê²½ìš°
          if (body.includes('```') || body.includes('`')) {
            labels.add('has-code');
          }

          // ìŠ¤í¬ë¦°ìƒ·ì´ë‚˜ ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°
          if (body.includes('![') || body.includes('screenshot') || body.includes('image')) {
            labels.add('has-media');
          }

          // ê¸°ë³¸ ë¼ë²¨ì´ ì—†ìœ¼ë©´ 'triage' ì¶”ê°€
          const coreLabels = ['bug', 'feature', 'documentation', 'question', 'security', 'performance'];
          const hasCoreLabel = coreLabels.some(label => labels.has(label));
          if (!hasCoreLabel) {
            labels.add('triage');
          }

          return Array.from(labels);

    - name: í•„ìš”í•œ ë¼ë²¨ ìƒì„±
      uses: actions/github-script@v7
      with:
        script: |
          const labelsToCreate = [
            // íƒ€ì… ë¼ë²¨
            { name: 'bug', color: 'd73a4a', description: 'Something is not working' },
            { name: 'feature', color: '0e8a16', description: 'New feature or enhancement' },
            { name: 'documentation', color: '0075ca', description: 'Improvements or additions to documentation' },
            { name: 'question', color: 'd876e3', description: 'Further information is requested' },
            { name: 'security', color: 'ee0701', description: 'Security related issue' },
            { name: 'performance', color: 'fbca04', description: 'Performance improvement' },
            { name: 'ui/ux', color: 'e99695', description: 'User interface and experience' },
            
            // ìš°ì„ ìˆœìœ„ ë¼ë²¨
            { name: 'priority: critical', color: 'b60205', description: 'Critical priority - immediate attention needed' },
            { name: 'priority: high', color: 'd93f0b', description: 'High priority' },
            { name: 'priority: low', color: '0e8a16', description: 'Low priority' },
            
            // ì˜ì—­ ë¼ë²¨
            { name: 'area: backend', color: '0052cc', description: 'Backend related' },
            { name: 'area: frontend', color: '0e8a16', description: 'Frontend related' },
            { name: 'area: agent', color: 'd4c5f9', description: 'AI Agent related' },
            { name: 'area: infrastructure', color: 'fef2c0', description: 'Infrastructure and deployment' },
            { name: 'area: testing', color: 'f9d0c4', description: 'Testing related' },
            
            // ìƒíƒœ ë¼ë²¨
            { name: 'status: needs-reproduction', color: 'ffcc00', description: 'Needs steps to reproduce' },
            { name: 'duplicate', color: 'cfd3d7', description: 'This issue already exists' },
            { name: 'wontfix', color: 'ffffff', description: 'This will not be worked on' },
            { name: 'triage', color: 'ededed', description: 'Needs triage' },
            
            // ë‚œì´ë„/ê¸°ì—¬ ë¼ë²¨
            { name: 'good first issue', color: '7057ff', description: 'Good for newcomers' },
            { name: 'help wanted', color: '008672', description: 'Extra attention is needed' },
            { name: 'new contributor', color: 'ff6ec7', description: 'Issue created by a new contributor' },
            
            // ë©”íƒ€ ë¼ë²¨
            { name: 'early issue', color: 'c5def5', description: 'One of the early issues' },
            { name: 'needs-detail', color: 'ffd33d', description: 'More details needed' },
            { name: 'no-template', color: 'f29513', description: 'Created without using issue template' },
            { name: 'external-reference', color: 'bfe5bf', description: 'Contains external references' },
            { name: 'has-code', color: '1d76db', description: 'Contains code examples' },
            { name: 'has-media', color: '0969da', description: 'Contains screenshots or media' }
          ];

          // ê¸°ì¡´ ë¼ë²¨ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          const { data: existingLabels } = await github.rest.issues.listLabelsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });

          const existingLabelNames = existingLabels.map(label => label.name);

          // ì—†ëŠ” ë¼ë²¨ë§Œ ìƒì„±
          for (const label of labelsToCreate) {
            if (!existingLabelNames.includes(label.name)) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`Created label: ${label.name}`);
              } catch (error) {
                console.log(`Failed to create label ${label.name}: ${error.message}`);
              }
            }
          }

    - name: ë¼ë²¨ ì ìš©
      uses: actions/github-script@v7
      with:
        script: |
          const labels = ${{ steps.label-analysis.outputs.result }};
          
          if (labels && labels.length > 0) {
            try {
              // ê¸°ì¡´ ë¼ë²¨ê³¼ ìƒˆ ë¼ë²¨ ë³‘í•© (ì¤‘ë³µ ì œê±°)
              const { data: currentIssue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const currentLabels = currentIssue.labels.map(label => label.name);
              const allLabels = [...new Set([...currentLabels, ...labels])];

              await github.rest.issues.setLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: allLabels
              });
              
              console.log(`ì ìš©ëœ ë¼ë²¨: ${allLabels.join(', ')}`);
              
              // ìƒˆë¡œ ì¶”ê°€ëœ ë¼ë²¨ë§Œ ì°¾ê¸°
              const newLabels = labels.filter(label => !currentLabels.includes(label));
              
              if (newLabels.length > 0) {
                // ë¼ë²¨ ì ìš© ì™„ë£Œ ëŒ“ê¸€
                const labelComment = `ğŸ·ï¸ **ìë™ ë¼ë²¨ë§ ì™„ë£Œ**\n\n` +
                  `ë‹¤ìŒ ë¼ë²¨ë“¤ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:\n` +
                  `${newLabels.map(label => `\`${label}\``).join(', ')}\n\n` +
                  `**ë¼ë²¨ ë¶„ë¥˜ ê¸°ì¤€:**\n` +
                  `- ì´ìŠˆ ì œëª©ê³¼ ë‚´ìš©ì˜ í‚¤ì›Œë“œ ë¶„ì„\n` +
                  `- ê¸°ì—¬ì íˆìŠ¤í† ë¦¬ ë¶„ì„\n` +
                  `- ì´ìŠˆ êµ¬ì¡° ë° í˜•ì‹ ë¶„ì„\n\n` +
                  `ë¼ë²¨ì´ ë¶€ì •í™•í•˜ë‹¤ë©´ ì–¸ì œë“  ìˆ˜ì •í•´ ì£¼ì„¸ìš”!\n\n` +
                  `---\nğŸ¤– ìë™ ë¼ë²¨ë§ ì‹œìŠ¤í…œ`;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: labelComment
                });
              }
            } catch (error) {
              console.log(`ë¼ë²¨ ì ìš© ì‹¤íŒ¨: ${error.message}`);
            }
          }

    - name: íŠ¹ë³„ ìƒí™© ì²˜ë¦¬
      uses: actions/github-script@v7
      with:
        script: |
          const labels = ${{ steps.label-analysis.outputs.result }};
          
          // needs-detail ë¼ë²¨ì´ ìˆìœ¼ë©´ ì¶”ê°€ ì •ë³´ ìš”ì²­ ëŒ“ê¸€
          if (labels.includes('needs-detail')) {
            const detailComment = `ğŸ“ **ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤**\n\n` +
              `ì´ìŠˆë¥¼ ë” ì˜ ì´í•´í•˜ê³  ë„ì›€ì„ ë“œë¦¬ê¸° ìœ„í•´ ë‹¤ìŒ ì •ë³´ë¥¼ ì¶”ê°€ë¡œ ì œê³µí•´ ì£¼ì„¸ìš”:\n\n` +
              `**ê¸°ë³¸ ì •ë³´:**\n` +
              `- [ ] ë¬¸ì œì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…\n` +
              `- [ ] ì¬í˜„ ë‹¨ê³„ (ë‹¨ê³„ë³„ë¡œ)\n` +
              `- [ ] ì˜ˆìƒ ê²°ê³¼ì™€ ì‹¤ì œ ê²°ê³¼\n` +
              `- [ ] í™˜ê²½ ì •ë³´ (OS, Python ë²„ì „ ë“±)\n\n` +
              `**ì¶”ê°€ ë„ì›€ì´ ë˜ëŠ” ì •ë³´:**\n` +
              `- [ ] ì—ëŸ¬ ë©”ì‹œì§€ë‚˜ ë¡œê·¸\n` +
              `- [ ] ìŠ¤í¬ë¦°ìƒ· (í•´ë‹¹í•˜ëŠ” ê²½ìš°)\n` +
              `- [ ] ê´€ë ¨ ì½”ë“œ ìŠ¤ë‹ˆí«\n\n` +
              `ë” ìì„¸í•œ ì •ë³´ë¥¼ ì œê³µí•´ ì£¼ì‹œë©´ ë” ë¹ ë¥´ê³  ì •í™•í•œ ì§€ì›ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ™\n\n` +
              `---\nğŸ¤– ìë™ ì•ˆë‚´ ì‹œìŠ¤í…œ`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: detailComment
            });
          }

          // ë³´ì•ˆ ë¼ë²¨ì´ ìˆìœ¼ë©´ íŠ¹ë³„ ì•ˆë‚´
          if (labels.includes('security')) {
            const securityComment = `ğŸ”’ **ë³´ì•ˆ ê´€ë ¨ ì´ìŠˆ ê°ì§€**\n\n` +
              `âš ï¸ **ì¤‘ìš”í•œ ì•ˆë‚´:**\n` +
              `ì´ ì´ìŠˆê°€ ë³´ì•ˆê³¼ ê´€ë ¨ëœ ê²ƒìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
              `**ë§Œì•½ ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì ì´ë¼ë©´:**\n` +
              `- ì´ ê³µê°œ ì´ìŠˆ ëŒ€ì‹  ë¹„ê³µê°œë¡œ ì‹ ê³ í•´ ì£¼ì„¸ìš”\n` +
              `- ë³´ì•ˆíŒ€ ì´ë©”ì¼: [ë³´ì•ˆíŒ€ ì—°ë½ì²˜]\n` +
              `- ê³µê°œì ìœ¼ë¡œ ì•Œë ¤ì§€ë©´ ì•ˆ ë˜ëŠ” ì„¸ë¶€ì‚¬í•­ì€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”\n\n` +
              `**ì¼ë°˜ì ì¸ ë³´ì•ˆ ê´€ë ¨ ì§ˆë¬¸ì´ë¼ë©´:**\n` +
              `- í˜„ì¬ ì´ìŠˆë¡œ ê³„ì† ì§„í–‰í•˜ì…”ë„ ë©ë‹ˆë‹¤\n` +
              `- ë³´ì•ˆíŒ€ì´ ê²€í† í•˜ê³  ì ì ˆí•œ ì¡°ì¹˜ë¥¼ ì·¨í•©ë‹ˆë‹¤\n\n` +
              `ë³´ì•ˆ ë¬¸ì œë¥¼ ì‹ ê³ í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ›¡ï¸\n\n` +
              `---\nğŸ”’ ë³´ì•ˆíŒ€ ìë™ ì•Œë¦¼`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: securityComment
            });
          }

          // good first issue ë¼ë²¨ì´ ìˆìœ¼ë©´ í™˜ì˜ ë©”ì‹œì§€
          if (labels.includes('good first issue')) {
            const welcomeComment = `ğŸŒŸ **ì²« ê¸°ì—¬ì— ì¢‹ì€ ì´ìŠˆì…ë‹ˆë‹¤!**\n\n` +
              `ì´ ì´ìŠˆëŠ” ìƒˆë¡œìš´ ê¸°ì—¬ìë“¤ì—ê²Œ ì í•©í•œ ê²ƒìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
              `**ê¸°ì—¬ë¥¼ ì›í•˜ì‹ ë‹¤ë©´:**\n` +
              `1. ì´ ì´ìŠˆì— ëŒ“ê¸€ì„ ë‚¨ê²¨ ì‘ì—… ì˜ì‚¬ë¥¼ í‘œí˜„í•´ ì£¼ì„¸ìš”\n` +
              `2. [ê¸°ì—¬ ê°€ì´ë“œ](../CONTRIBUTING.md)ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”\n` +
              `3. ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ëŒ“ê¸€ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”\n\n` +
              `**ë©˜í† ë§ ì§€ì›:**\n` +
              `- ì»¤ë®¤ë‹ˆí‹° ë§¤ë‹ˆì €ê°€ ê¸°ì—¬ ê³¼ì •ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤\n` +
              `- ì½”ë“œ ë¦¬ë·° ì‹œ ìì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤\n` +
              `- ë§‰íˆëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ë„ì›€ì„ ìš”ì²­í•˜ì„¸ìš”\n\n` +
              `ì²« ê¸°ì—¬ë¥¼ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰\n\n` +
              `---\nğŸ¤ ì»¤ë®¤ë‹ˆí‹° í™˜ì˜ ì‹œìŠ¤í…œ`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: welcomeComment
            });
          } 