name: PR ìžë™ í• ë‹¹

on:
  pull_request:
    types: [opened, reopened]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files_yaml: |
          backend:
            - 'backend/**'
            - '**/*api*'
          frontend:
            - 'frontend/**'
            - '**/*ui*'
            - '**/*component*'
          agent:
            - 'agent/**'
            - '**/*agent*'
          tests:
            - 'tests/**'
            - '**/*test*'
          docs:
            - 'docs/**'
            - '**/*.md'
            - '**/*.rst'
          config:
            - 'config.py'
            - '**/*config*'
            - '**/*.yml'
            - '**/*.yaml'

    - name: íŒ€ì› ë¦¬ìŠ¤íŠ¸ ë° í• ë‹¹ ë¡œì§
      id: assign-logic
      uses: actions/github-script@v7
      with:
        script: |
          // íŒ€ì› ì •ë³´ (ì‹¤ì œ GitHub ì‚¬ìš©ìžëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const teamMembers = {
            backend: ['backend-dev1', 'backend-dev2'],
            frontend: ['frontend-dev1', 'frontend-dev2'], 
            agent: ['ai-dev1', 'ai-dev2'],
            devops: ['devops-dev1'],
            lead: ['team-lead']
          };

          // ëª¨ë“  íŒ€ì›ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê¸°
          const allMembers = [
            ...teamMembers.backend,
            ...teamMembers.frontend,
            ...teamMembers.agent,
            ...teamMembers.devops,
            ...teamMembers.lead
          ];

          // ë³€ê²½ëœ íŒŒì¼ ì˜ì—­ë³„ ë‹´ë‹¹ìž ê²°ì •
          let assignees = new Set();
          
          // ë³€ê²½ëœ íŒŒì¼ ì˜ì—­ì— ë”°ë¥¸ ë‹´ë‹¹ìž í• ë‹¹
          if ('${{ steps.changed-files.outputs.backend_any_changed }}' === 'true') {
            const randomBackend = teamMembers.backend[Math.floor(Math.random() * teamMembers.backend.length)];
            assignees.add(randomBackend);
          }
          
          if ('${{ steps.changed-files.outputs.frontend_any_changed }}' === 'true') {
            const randomFrontend = teamMembers.frontend[Math.floor(Math.random() * teamMembers.frontend.length)];
            assignees.add(randomFrontend);
          }
          
          if ('${{ steps.changed-files.outputs.agent_any_changed }}' === 'true') {
            const randomAgent = teamMembers.agent[Math.floor(Math.random() * teamMembers.agent.length)];
            assignees.add(randomAgent);
          }

          // ì„¤ì • íŒŒì¼ ë³€ê²½ ì‹œ DevOps íŒ€ í• ë‹¹
          if ('${{ steps.changed-files.outputs.config_any_changed }}' === 'true') {
            assignees.add(teamMembers.devops[0]);
          }

          // ë¬¸ì„œ ë³€ê²½ ì‹œ íŒ€ ë¦¬ë“œ í• ë‹¹
          if ('${{ steps.changed-files.outputs.docs_any_changed }}' === 'true') {
            assignees.add(teamMembers.lead[0]);
          }

          // ë‹´ë‹¹ìžê°€ ì—†ìœ¼ë©´ ëžœë¤í•˜ê²Œ í• ë‹¹
          if (assignees.size === 0) {
            const randomMember = allMembers[Math.floor(Math.random() * allMembers.length)];
            assignees.add(randomMember);
          }

          // PR ìž‘ì„±ìžëŠ” ì œì™¸
          const prAuthor = '${{ github.event.pull_request.user.login }}';
          assignees.delete(prAuthor);

          // ìµœì†Œ 1ëª…ì€ í• ë‹¹ë˜ë„ë¡ ë³´ìž¥
          if (assignees.size === 0) {
            const randomMember = allMembers.filter(member => member !== prAuthor)[0];
            if (randomMember) assignees.add(randomMember);
          }

          return Array.from(assignees);

    - name: PRì— ë‹´ë‹¹ìž í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const assignees = ${{ steps.assign-logic.outputs.result }};
          
          if (assignees && assignees.length > 0) {
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: assignees
              });
              
              console.log(`í• ë‹¹ëœ ë‹´ë‹¹ìž: ${assignees.join(', ')}`);
              
              // í• ë‹¹ ì™„ë£Œ ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸŽ¯ **ìžë™ ë‹´ë‹¹ìž í• ë‹¹ ì™„ë£Œ**\n\në‹¤ìŒ ë¶„ë“¤ì´ ì´ PRì˜ ë‹´ë‹¹ìžë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤:\n${assignees.map(assignee => `- @${assignee}`).join('\n')}\n\në³€ê²½ëœ íŒŒì¼ ì˜ì—­ì„ ê¸°ë°˜ìœ¼ë¡œ ìžë™ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ë‹´ë‹¹ìžë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”!\n\n---\nðŸ¤– ìžë™ í• ë‹¹ ì‹œìŠ¤í…œ`
              });
            } catch (error) {
              console.log(`ë‹´ë‹¹ìž í• ë‹¹ ì‹¤íŒ¨: ${error.message}`);
              console.log('ì‚¬ìš© ê°€ëŠ¥í•œ í˜‘ë ¥ìžê°€ ì•„ë‹ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.');
            }
          }

    - name: ë¦¬ë·°ì–´ ìš”ì²­
      uses: actions/github-script@v7
      with:
        script: |
          const assignees = ${{ steps.assign-logic.outputs.result }};
          
          if (assignees && assignees.length > 0) {
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: assignees
              });
              
              console.log(`ë¦¬ë·°ì–´ ìš”ì²­ ì™„ë£Œ: ${assignees.join(', ')}`);
            } catch (error) {
              console.log(`ë¦¬ë·°ì–´ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`);
            }
          } 