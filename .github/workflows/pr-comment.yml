name: PR ìë™ ëŒ“ê¸€

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-comment:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: PR ì •ë³´ ìˆ˜ì§‘
      id: pr-info
      run: |
        echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
        echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
        echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
        echo "head_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT

    - name: ë³€ê²½ëœ íŒŒì¼ ìˆ˜ì§‘
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          **/*.py
          **/*.yml
          **/*.yaml
          **/*.md

    - name: í…ŒìŠ¤íŠ¸ íŒŒì¼ í™•ì¸
      id: test-check
      run: |
        if [ -d "tests/" ]; then
          test_files=$(find tests/ -name "*.py" -type f | wc -l)
          echo "test_files_count=$test_files" >> $GITHUB_OUTPUT
          echo "has_tests=true" >> $GITHUB_OUTPUT
        else
          echo "has_tests=false" >> $GITHUB_OUTPUT
          echo "test_files_count=0" >> $GITHUB_OUTPUT
        fi

    - name: PR ì²´í¬ë¦¬ìŠ¤íŠ¸ ëŒ“ê¸€ ìƒì„±
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('## ğŸ“‹ PR ì²´í¬ë¦¬ìŠ¤íŠ¸')
          );

          const changedFiles = `${{ steps.changed-files.outputs.all_changed_files }}`.split(' ');
          const pythonFiles = changedFiles.filter(file => file.endsWith('.py'));
          const testFiles = changedFiles.filter(file => file.includes('test'));

          const commentBody = `## ğŸ“‹ PR ì²´í¬ë¦¬ìŠ¤íŠ¸

          ì•ˆë…•í•˜ì„¸ìš” @${{ steps.pr-info.outputs.pr_author }}ë‹˜! PRì„ ìƒì„±í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ‰

          ### ğŸ“Š PR ì •ë³´
          - **ë² ì´ìŠ¤ ë¸Œëœì¹˜**: \`${{ steps.pr-info.outputs.base_branch }}\`
          - **í—¤ë“œ ë¸Œëœì¹˜**: \`${{ steps.pr-info.outputs.head_branch }}\`
          - **ë³€ê²½ëœ Python íŒŒì¼**: ${pythonFiles.length}ê°œ
          - **í…ŒìŠ¤íŠ¸ íŒŒì¼**: ${testFiles.length}ê°œ

          ### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
          ë¨¸ì§€í•˜ê¸° ì „ì— ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:

          - [ ] ğŸ§ª **í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±**: ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ë‚˜ ë²„ê·¸ ìˆ˜ì •ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆë‚˜ìš”?
          - [ ] ğŸ“– **ë¬¸ì„œ ì—…ë°ì´íŠ¸**: READMEë‚˜ ê´€ë ¨ ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆë‚˜ìš”?
          - [ ] ğŸ” **ì½”ë“œ ë¦¬ë·°**: ì½”ë“œ ë¦¬ë·°ë¥¼ ìš”ì²­í•˜ì…¨ë‚˜ìš”?
          - [ ] ğŸ—ï¸ **ë¹Œë“œ ì„±ê³µ**: ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ë‚˜ìš”?
          - [ ] ğŸ“ **ì»¤ë°‹ ë©”ì‹œì§€**: ì»¤ë°‹ ë©”ì‹œì§€ê°€ ëª…í™•í•˜ê³  ê·œì¹™ì— ë§ë‚˜ìš”?

          ### ğŸš€ ìë™ ê²€ì‚¬ ê²°ê³¼
          - **í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ì¡´ì¬**: ${{ steps.test-check.outputs.has_tests }}
          - **í…ŒìŠ¤íŠ¸ íŒŒì¼ ìˆ˜**: ${{ steps.test-check.outputs.test_files_count }}ê°œ

          ### ğŸ“‹ ì¶”ê°€ ì•ˆë‚´
          - ì´ PRì´ ì´ìŠˆì™€ ê´€ë ¨ì´ ìˆë‹¤ë©´ \`Closes #ì´ìŠˆë²ˆí˜¸\`ë¥¼ PR ì„¤ëª…ì— ì¶”ê°€í•´ì£¼ì„¸ìš”.
          - ë³€ê²½ì‚¬í•­ì´ í¬ë‹¤ë©´ ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ„ì–´ì„œ PRì„ ìƒì„±í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.
          - ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ëŒ“ê¸€ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”!

          ---
          ğŸ¤– ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`;

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          } 