name: ì´ìŠˆ ìë™ í• ë‹¹

on:
  issues:
    types: [opened, reopened]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì´ìŠˆ ë¶„ì„ ë° ë‹´ë‹¹ì ê²°ì •
      id: assign-logic
      uses: actions/github-script@v7
      with:
        script: |
          const issue = context.payload.issue;
          const title = issue.title.toLowerCase();
          const body = (issue.body || '').toLowerCase();
          const author = issue.user.login;
          
          // íŒ€ì› ì •ë³´ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          const teamMembers = {
            backend: ['backend-dev1', 'backend-dev2'],
            frontend: ['frontend-dev1', 'frontend-dev2'],
            agent: ['ai-dev1', 'ai-dev2'],
            devops: ['devops-dev1'],
            security: ['security-dev1'],
            lead: ['team-lead'],
            community: ['community-manager']
          };

          // ëª¨ë“  íŒ€ì›ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê¸°
          const allMembers = [
            ...teamMembers.backend,
            ...teamMembers.frontend,
            ...teamMembers.agent,
            ...teamMembers.devops,
            ...teamMembers.security,
            ...teamMembers.lead,
            ...teamMembers.community
          ];

          // ì´ìŠˆ íƒ€ì…ë³„ í‚¤ì›Œë“œì™€ ë‹´ë‹¹ íŒ€ ë§¤í•‘
          const assignmentRules = {
            backend: {
              keywords: ['api', 'backend', 'server', 'database', 'db', 'auth', 'login', 'ë°±ì—”ë“œ', 'ì„œë²„', 'ë°ì´í„°ë² ì´ìŠ¤', 'ì¸ì¦'],
              team: teamMembers.backend
            },
            frontend: {
              keywords: ['ui', 'frontend', 'interface', 'component', 'css', 'html', 'react', 'vue', 'í”„ë¡ íŠ¸ì—”ë“œ', 'í™”ë©´', 'ì¸í„°í˜ì´ìŠ¤'],
              team: teamMembers.frontend
            },
            agent: {
              keywords: ['ai', 'agent', 'chatbot', 'llm', 'gpt', 'model', 'inference', 'ì—ì´ì „íŠ¸', 'ì±—ë´‡', 'ëª¨ë¸'],
              team: teamMembers.agent
            },
            devops: {
              keywords: ['deploy', 'deployment', 'ci', 'cd', 'docker', 'kubernetes', 'infra', 'pipeline', 'ë°°í¬', 'ì¸í”„ë¼'],
              team: teamMembers.devops
            },
            security: {
              keywords: ['security', 'vulnerability', 'cve', 'attack', 'breach', 'exploit', 'ë³´ì•ˆ', 'ì·¨ì•½ì ', 'ê³µê²©'],
              team: teamMembers.security
            }
          };

          // ìš°ì„ ìˆœìœ„ë³„ í‚¤ì›Œë“œ
          const priorityKeywords = {
            critical: ['critical', 'urgent', 'emergency', 'breaking', 'down', 'ê¸´ê¸‰', 'í¬ë¦¬í‹°ì»¬', 'ì¤‘ë‹¨'],
            high: ['high', 'important', 'serious', 'major', 'ë†’ìŒ', 'ì¤‘ìš”', 'ì‹¬ê°'],
            low: ['low', 'minor', 'trivial', 'enhancement', 'ë‚®ìŒ', 'ì‚¬ì†Œ', 'ë¯¸ë¯¸', 'ê°œì„ ']
          };

          // ì´ìŠˆ íƒ€ì…ë³„ í‚¤ì›Œë“œ
          const typeKeywords = {
            bug: ['bug', 'error', 'issue', 'problem', 'fail', 'crash', 'ë²„ê·¸', 'ì˜¤ë¥˜', 'ë¬¸ì œ', 'ì‹¤íŒ¨'],
            feature: ['feature', 'enhancement', 'improve', 'add', 'ê¸°ëŠ¥', 'ê°œì„ ', 'ì¶”ê°€'],
            question: ['question', 'help', 'how', 'why', 'ì§ˆë¬¸', 'ë„ì›€', 'ì–´ë–»ê²Œ'],
            documentation: ['doc', 'document', 'readme', 'guide', 'ë¬¸ì„œ', 'ì„¤ëª…', 'ê°€ì´ë“œ']
          };

          let assignees = new Set();
          let detectedPriority = 'medium';
          let detectedType = 'general';

          // ìš°ì„ ìˆœìœ„ ê°ì§€
          for (const [priority, keywords] of Object.entries(priorityKeywords)) {
            if (keywords.some(keyword => title.includes(keyword) || body.includes(keyword))) {
              detectedPriority = priority;
              break;
            }
          }

          // ì´ìŠˆ íƒ€ì… ê°ì§€
          for (const [type, keywords] of Object.entries(typeKeywords)) {
            if (keywords.some(keyword => title.includes(keyword) || body.includes(keyword))) {
              detectedType = type;
              break;
            }
          }

          // ì˜ì—­ë³„ ë‹´ë‹¹ì í• ë‹¹
          for (const [area, rule] of Object.entries(assignmentRules)) {
            if (rule.keywords.some(keyword => title.includes(keyword) || body.includes(keyword))) {
              const randomMember = rule.team[Math.floor(Math.random() * rule.team.length)];
              assignees.add(randomMember);
            }
          }

          // íŠ¹ë³„ ê·œì¹™ ì ìš©
          if (detectedPriority === 'critical') {
            // í¬ë¦¬í‹°ì»¬í•œ ì´ìŠˆëŠ” íŒ€ ë¦¬ë“œ í• ë‹¹
            assignees.add(teamMembers.lead[0]);
          }

          if (detectedType === 'security') {
            // ë³´ì•ˆ ì´ìŠˆëŠ” ë³´ì•ˆ íŒ€ í• ë‹¹
            assignees.add(teamMembers.security[0]);
          }

          if (detectedType === 'question' && assignees.size === 0) {
            // ì§ˆë¬¸ì´ë©´ì„œ íŠ¹ì • ì˜ì—­ì´ ì—†ìœ¼ë©´ ì»¤ë®¤ë‹ˆí‹° ë§¤ë‹ˆì € í• ë‹¹
            assignees.add(teamMembers.community[0]);
          }

          // ì‹ ê·œ ê¸°ì—¬ìì¸ì§€ í™•ì¸
          const { data: userIssues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            creator: author,
            state: 'all'
          });

          const isNewContributor = userIssues.length <= 1; // ì²« ë²ˆì§¸ ì´ìŠˆ

          if (isNewContributor) {
            // ì‹ ê·œ ê¸°ì—¬ìë©´ ì»¤ë®¤ë‹ˆí‹° ë§¤ë‹ˆì €ë„ ì¶”ê°€
            assignees.add(teamMembers.community[0]);
          }

          // ë‹´ë‹¹ìê°€ ì—†ìœ¼ë©´ ë¡œë“œ ë°¸ëŸ°ì‹±ìœ¼ë¡œ í• ë‹¹
          if (assignees.size === 0) {
            // ìµœê·¼ í• ë‹¹ëœ ì´ìŠˆê°€ ì ì€ íŒ€ì›ì„ ì°¾ê¸°
            let memberWorkload = {};
            
            // ëª¨ë“  íŒ€ì›ì˜ ì›Œí¬ë¡œë“œ ì´ˆê¸°í™”
            for (const member of allMembers) {
              memberWorkload[member] = 0;
            }

            // ìµœê·¼ 30ì¼ê°„ í• ë‹¹ëœ ì´ìŠˆ ìˆ˜ ê³„ì‚°
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const { data: recentIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              since: thirtyDaysAgo.toISOString()
            });

            for (const recentIssue of recentIssues) {
              if (recentIssue.assignees) {
                for (const assignee of recentIssue.assignees) {
                  if (memberWorkload.hasOwnProperty(assignee.login)) {
                    memberWorkload[assignee.login]++;
                  }
                }
              }
            }

            // ì›Œí¬ë¡œë“œê°€ ê°€ì¥ ì ì€ íŒ€ì› ì„ íƒ
            const sortedMembers = Object.entries(memberWorkload)
              .sort(([,a], [,b]) => a - b)
              .map(([member,]) => member);

            if (sortedMembers.length > 0) {
              assignees.add(sortedMembers[0]);
            }
          }

          // ì´ìŠˆ ì‘ì„±ìëŠ” ì œì™¸
          assignees.delete(author);

          // ìµœì†Œ 1ëª…ì€ í• ë‹¹ë˜ë„ë¡ ë³´ì¥
          if (assignees.size === 0) {
            const randomMember = allMembers.filter(member => member !== author)[0];
            if (randomMember) assignees.add(randomMember);
          }

          return {
            assignees: Array.from(assignees),
            priority: detectedPriority,
            type: detectedType,
            isNewContributor: isNewContributor
          };

    - name: ì´ìŠˆì— ë‹´ë‹¹ì í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const result = ${{ steps.assign-logic.outputs.result }};
          const assignees = result.assignees;
          
          if (assignees && assignees.length > 0) {
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: assignees
              });
              
              console.log(`í• ë‹¹ëœ ë‹´ë‹¹ì: ${assignees.join(', ')}`);
              
              // í• ë‹¹ ì •ë³´ ëŒ“ê¸€ ìƒì„±
              let assignmentComment = `ğŸ¯ **ìë™ ë‹´ë‹¹ì í• ë‹¹ ì™„ë£Œ**\n\n`;
              assignmentComment += `ë‹¤ìŒ ë¶„ë“¤ì´ ì´ ì´ìŠˆì˜ ë‹´ë‹¹ìë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤:\n`;
              assignmentComment += `${assignees.map(assignee => `- @${assignee}`).join('\n')}\n\n`;
              
              // í• ë‹¹ ì´ìœ  ì„¤ëª…
              assignmentComment += `**í• ë‹¹ ê¸°ì¤€:**\n`;
              if (result.type !== 'general') {
                assignmentComment += `- ì´ìŠˆ íƒ€ì…: \`${result.type}\`\n`;
              }
              if (result.priority !== 'medium') {
                assignmentComment += `- ìš°ì„ ìˆœìœ„: \`${result.priority}\`\n`;
              }
              if (result.isNewContributor) {
                assignmentComment += `- ì‹ ê·œ ê¸°ì—¬ì ì§€ì›\n`;
              }
              assignmentComment += `- ì›Œí¬ë¡œë“œ ê· í˜• ê³ ë ¤\n\n`;
              
              // ì‘ë‹µ ì‹œê°„ ì•ˆë‚´
              const responseTime = {
                'critical': '2ì‹œê°„ ì´ë‚´',
                'high': '24ì‹œê°„ ì´ë‚´',
                'medium': '2-3ì¼ ì´ë‚´',
                'low': '1ì£¼ì¼ ì´ë‚´'
              };
              
              assignmentComment += `**ì˜ˆìƒ ì‘ë‹µ ì‹œê°„:** ${responseTime[result.priority] || responseTime['medium']}\n\n`;
              assignmentComment += `ë‹´ë‹¹ìê°€ ì ì ˆí•˜ì§€ ì•Šë‹¤ë©´ ì–¸ì œë“  ë³€ê²½í•´ ì£¼ì„¸ìš”!\n\n`;
              assignmentComment += `---\nğŸ¤– ìë™ í• ë‹¹ ì‹œìŠ¤í…œ`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: assignmentComment
              });
            } catch (error) {
              console.log(`ë‹´ë‹¹ì í• ë‹¹ ì‹¤íŒ¨: ${error.message}`);
              
              // í• ë‹¹ ì‹¤íŒ¨ ì‹œ ì•ˆë‚´ ëŒ“ê¸€
              const fallbackComment = `âš ï¸ **ìë™ ë‹´ë‹¹ì í• ë‹¹ ì‹¤íŒ¨**\n\n` +
                `ìë™ í• ë‹¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì¤‘ í•œ ë¶„ì´ ìˆ˜ë™ìœ¼ë¡œ í• ë‹¹í•´ ì£¼ì„¸ìš”:\n` +
                `${assignees.map(assignee => `- @${assignee}`).join('\n')}\n\n` +
                `ì˜¤ë¥˜: ${error.message}\n\n` +
                `---\nğŸ¤– ìë™ í• ë‹¹ ì‹œìŠ¤í…œ`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: fallbackComment
              });
            }
          }

    - name: ê¸´ê¸‰ ì´ìŠˆ ì•Œë¦¼
      if: steps.assign-logic.outputs.result && fromJSON(steps.assign-logic.outputs.result).priority == 'critical'
      uses: actions/github-script@v7
      with:
        script: |
          const result = ${{ steps.assign-logic.outputs.result }};
          
          // ê¸´ê¸‰ ì´ìŠˆ ì•Œë¦¼ ëŒ“ê¸€
          const urgentComment = `ğŸš¨ **ê¸´ê¸‰ ì´ìŠˆ ê°ì§€**\n\n` +
            `ì´ ì´ìŠˆëŠ” ê¸´ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
            `**ì¦‰ì‹œ ì¡°ì¹˜ ì‚¬í•­:**\n` +
            `- [ ] ë‹´ë‹¹ìëŠ” 2ì‹œê°„ ì´ë‚´ì— ì²« ì‘ë‹µ í•„ìš”\n` +
            `- [ ] ì‹¬ê°ë„ í‰ê°€ ë° ëŒ€ì‘ ê³„íš ìˆ˜ë¦½\n` +
            `- [ ] í•„ìš”ì‹œ í•«í”½ìŠ¤ ë¦´ë¦¬ìŠ¤ ì¤€ë¹„\n` +
            `- [ ] ê´€ë ¨ íŒ€ì›ë“¤ì—ê²Œ ìƒí™© ê³µìœ \n\n` +
            `**ì—ìŠ¤ì»¬ë ˆì´ì…˜ ì ˆì°¨:**\n` +
            `- 2ì‹œê°„ ë‚´ ì‘ë‹µì´ ì—†ìœ¼ë©´ íŒ€ ë¦¬ë“œì—ê²Œ ì—ìŠ¤ì»¬ë ˆì´ì…˜\n` +
            `- 4ì‹œê°„ ë‚´ í•´ê²° ë°©í–¥ì´ ì—†ìœ¼ë©´ ì„ì‹œ ì¡°ì¹˜ ê²€í† \n\n` +
            `---\nğŸš¨ ê¸´ê¸‰ ì´ìŠˆ ì•Œë¦¼ ì‹œìŠ¤í…œ`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: urgentComment
          }); 