name: PR ìë™ ì½”ë“œ ë¦¬ë·°

on:
  pull_request:
    types: [opened, synchronize]
  workflow_run:
    workflows: ["í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰"]
    types: [completed]

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request')
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      id: pr-info
      uses: actions/github-script@v7
      with:
        script: |
          let prNumber;
          if (context.eventName === 'pull_request') {
            prNumber = context.issue.number;
          } else {
            // workflow_run ì´ë²¤íŠ¸ì˜ ê²½ìš°
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.payload.workflow_run.workflow_id,
              status: 'completed'
            });
            
            const run = runs.data.workflow_runs.find(r => r.id === context.payload.workflow_run.id);
            if (run && run.pull_requests.length > 0) {
              prNumber = run.pull_requests[0].number;
            } else {
              console.log('PR ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
          }
          
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber,
          });
          
          return {
            number: prNumber,
            title: pr.title,
            body: pr.body,
            base: pr.base.ref,
            head: pr.head.ref,
            author: pr.user.login
          };

    - name: ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files_yaml: |
          python:
            - '**/*.py'
          tests:
            - 'tests/**'
          config:
            - '**/*.yml'
            - '**/*.yaml'
            - 'config.py'
          requirements:
            - 'requirements*.txt'

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install flake8 pylint bandit safety mypy black isort
        pip install -r requirements.txt

    - name: ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (Black)
      id: black-check
      run: |
        if [ "${{ steps.changed-files.outputs.python_any_changed }}" == "true" ]; then
          echo "python_files_changed=true" >> $GITHUB_OUTPUT
          black --check --diff ${{ steps.changed-files.outputs.python_all_changed_files }} > black_report.txt 2>&1 || echo "black_issues=true" >> $GITHUB_OUTPUT
        else
          echo "python_files_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Import ì •ë ¬ ê²€ì‚¬ (isort)
      id: isort-check
      run: |
        if [ "${{ steps.changed-files.outputs.python_any_changed }}" == "true" ]; then
          isort --check-only --diff ${{ steps.changed-files.outputs.python_all_changed_files }} > isort_report.txt 2>&1 || echo "isort_issues=true" >> $GITHUB_OUTPUT
        fi

    - name: ë¦°íŠ¸ ê²€ì‚¬ (flake8)
      id: flake8-check
      run: |
        if [ "${{ steps.changed-files.outputs.python_any_changed }}" == "true" ]; then
          flake8 ${{ steps.changed-files.outputs.python_all_changed_files }} --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' > flake8_report.txt 2>&1 || echo "flake8_issues=true" >> $GITHUB_OUTPUT
        fi

    - name: ì½”ë“œ ë³µì¡ë„ ê²€ì‚¬ (pylint)
      id: pylint-check
      run: |
        if [ "${{ steps.changed-files.outputs.python_any_changed }}" == "true" ]; then
          pylint ${{ steps.changed-files.outputs.python_all_changed_files }} --output-format=text --score=yes > pylint_report.txt 2>&1 || echo "pylint_issues=true" >> $GITHUB_OUTPUT
        fi

    - name: ë³´ì•ˆ ê²€ì‚¬ (bandit)
      id: bandit-check
      run: |
        if [ "${{ steps.changed-files.outputs.python_any_changed }}" == "true" ]; then
          bandit -r ${{ steps.changed-files.outputs.python_all_changed_files }} -f txt > bandit_report.txt 2>&1 || echo "bandit_issues=true" >> $GITHUB_OUTPUT
        fi

    - name: íƒ€ì… ê²€ì‚¬ (mypy)
      id: mypy-check
      run: |
        if [ "${{ steps.changed-files.outputs.python_any_changed }}" == "true" ]; then
          mypy ${{ steps.changed-files.outputs.python_all_changed_files }} > mypy_report.txt 2>&1 || echo "mypy_issues=true" >> $GITHUB_OUTPUT
        fi

    - name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ (safety)
      id: safety-check
      run: |
        if [ "${{ steps.changed-files.outputs.requirements_any_changed }}" == "true" ]; then
          safety check > safety_report.txt 2>&1 || echo "safety_issues=true" >> $GITHUB_OUTPUT
        fi

    - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í™•ì¸
      id: coverage-check
      run: |
        if [ "${{ steps.changed-files.outputs.python_any_changed }}" == "true" ]; then
          if [ -d "tests/" ]; then
            pip install pytest-cov
            pytest tests/ --cov=. --cov-report=term --cov-report=json > coverage_report.txt 2>&1 || echo "coverage_issues=true" >> $GITHUB_OUTPUT
            if [ -f "coverage.json" ]; then
              coverage_percent=$(python -c "import json; data=json.load(open('coverage.json')); print(f\"{data['totals']['percent_covered']:.1f}\")")
              echo "coverage_percent=$coverage_percent" >> $GITHUB_OUTPUT
            fi
          else
            echo "coverage_percent=0" >> $GITHUB_OUTPUT
            echo "no_tests=true" >> $GITHUB_OUTPUT
          fi
        fi

    - name: ì½”ë“œ ë¦¬ë·° ëŒ“ê¸€ ìƒì„±
      uses: actions/github-script@v7
      with:
        script: |
          if (!${{ steps.pr-info.outputs.result }}) {
            console.log('PR ì •ë³´ê°€ ì—†ì–´ ë¦¬ë·°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
            return;
          }
          
          const prInfo = ${{ steps.pr-info.outputs.result }};
          const prNumber = prInfo.number;
          
          // ê¸°ì¡´ ë¦¬ë·° ëŒ“ê¸€ í™•ì¸
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });

          const existingReview = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ë³´ê³ ì„œ')
          );

          let reviewSummary = `# ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ë³´ê³ ì„œ\n\n`;
          reviewSummary += `**PR**: #${prNumber} - ${prInfo.title}\n`;
          reviewSummary += `**ì‘ì„±ì**: @${prInfo.author}\n`;
          reviewSummary += `**ë¸Œëœì¹˜**: \`${prInfo.head}\` â†’ \`${prInfo.base}\`\n\n`;

          // ë³€ê²½ íŒŒì¼ ì •ë³´
          const pythonChanged = '${{ steps.changed-files.outputs.python_any_changed }}' === 'true';
          const testsChanged = '${{ steps.changed-files.outputs.tests_any_changed }}' === 'true';
          
          if (pythonChanged) {
            reviewSummary += `## ğŸ“Š ì½”ë“œ ë¶„ì„ ê²°ê³¼\n\n`;
            
            // ì½”ë“œ ìŠ¤íƒ€ì¼ (Black)
            const blackIssues = '${{ steps.black-check.outputs.black_issues }}' === 'true';
            reviewSummary += `### ğŸ¨ ì½”ë“œ ìŠ¤íƒ€ì¼ (Black)\n`;
            if (blackIssues) {
              reviewSummary += `âŒ **ì½”ë“œ í¬ë§·íŒ… ê°œì„  í•„ìš”**\n`;
              reviewSummary += `\`\`\`\n`;
              reviewSummary += `black í¬ë§·íŒ… ê·œì¹™ì— ë§ì§€ ì•ŠëŠ” ì½”ë“œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
              reviewSummary += `í•´ê²°ë°©ë²•: black . ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ìë™ í¬ë§·íŒ…ì„ ì ìš©í•˜ì„¸ìš”.\n`;
              reviewSummary += `\`\`\`\n\n`;
            } else {
              reviewSummary += `âœ… **ì½”ë“œ í¬ë§·íŒ… ì–‘í˜¸**\n\n`;
            }

            // Import ì •ë ¬ (isort)
            const isortIssues = '${{ steps.isort-check.outputs.isort_issues }}' === 'true';
            reviewSummary += `### ğŸ“¦ Import ì •ë ¬ (isort)\n`;
            if (isortIssues) {
              reviewSummary += `âŒ **Import ì •ë ¬ ê°œì„  í•„ìš”**\n`;
              reviewSummary += `í•´ê²°ë°©ë²•: \`isort .\` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ importë¥¼ ì •ë ¬í•˜ì„¸ìš”.\n\n`;
            } else {
              reviewSummary += `âœ… **Import ì •ë ¬ ì–‘í˜¸**\n\n`;
            }

            // ë¦°íŠ¸ ê²€ì‚¬ (flake8)
            const flake8Issues = '${{ steps.flake8-check.outputs.flake8_issues }}' === 'true';
            reviewSummary += `### ğŸ” ì½”ë“œ í’ˆì§ˆ (flake8)\n`;
            if (flake8Issues) {
              reviewSummary += `âš ï¸ **ì½”ë”© ê·œì¹™ ìœ„ë°˜ ë°œê²¬**\n`;
              reviewSummary += `PEP 8 ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¥¼ ë”°ë¥´ì§€ ì•ŠëŠ” ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤.\n\n`;
            } else {
              reviewSummary += `âœ… **ì½”ë”© ê·œì¹™ ì¤€ìˆ˜**\n\n`;
            }

            // ë³´ì•ˆ ê²€ì‚¬ (bandit)
            const banditIssues = '${{ steps.bandit-check.outputs.bandit_issues }}' === 'true';
            reviewSummary += `### ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (bandit)\n`;
            if (banditIssues) {
              reviewSummary += `ğŸš¨ **ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬**\n`;
              reviewSummary += `ì½”ë“œì—ì„œ ì ì¬ì ì¸ ë³´ì•ˆ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.\n\n`;
            } else {
              reviewSummary += `âœ… **ë³´ì•ˆ ê²€ì‚¬ í†µê³¼**\n\n`;
            }

            // íƒ€ì… ê²€ì‚¬ (mypy)
            const mypyIssues = '${{ steps.mypy-check.outputs.mypy_issues }}' === 'true';
            reviewSummary += `### ğŸ·ï¸ íƒ€ì… ê²€ì‚¬ (mypy)\n`;
            if (mypyIssues) {
              reviewSummary += `âš ï¸ **íƒ€ì… íŒíŠ¸ ê°œì„  í•„ìš”**\n`;
              reviewSummary += `íƒ€ì… ê´€ë ¨ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. íƒ€ì… íŒíŠ¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•´ì£¼ì„¸ìš”.\n\n`;
            } else {
              reviewSummary += `âœ… **íƒ€ì… ê²€ì‚¬ í†µê³¼**\n\n`;
            }

            // í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
            const coveragePercent = '${{ steps.coverage-check.outputs.coverage_percent }}';
            const noTests = '${{ steps.coverage-check.outputs.no_tests }}' === 'true';
            
            reviewSummary += `### ğŸ§ª í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€\n`;
            if (noTests) {
              reviewSummary += `âŒ **í…ŒìŠ¤íŠ¸ ì—†ìŒ**\n`;
              reviewSummary += `í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ê±°ë‚˜ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. TDD ì›ì¹™ì— ë”°ë¼ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n`;
            } else if (coveragePercent) {
              const coverage = parseFloat(coveragePercent);
              if (coverage < 80) {
                reviewSummary += `âš ï¸ **ì»¤ë²„ë¦¬ì§€ ë¶€ì¡±: ${coverage}%**\n`;
                reviewSummary += `ê¶Œì¥ ì»¤ë²„ë¦¬ì§€(80%) ë¯¸ë‹¬ì…ë‹ˆë‹¤. ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.\n\n`;
              } else {
                reviewSummary += `âœ… **ì»¤ë²„ë¦¬ì§€ ì–‘í˜¸: ${coverage}%**\n\n`;
              }
            }

            // ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
            const safetyIssues = '${{ steps.safety-check.outputs.safety_issues }}' === 'true';
            if ('${{ steps.changed-files.outputs.requirements_any_changed }}' === 'true') {
              reviewSummary += `### ğŸ“¦ ì˜ì¡´ì„± ë³´ì•ˆ (safety)\n`;
              if (safetyIssues) {
                reviewSummary += `ğŸš¨ **ì·¨ì•½í•œ ì˜ì¡´ì„± ë°œê²¬**\n`;
                reviewSummary += `ë³´ì•ˆ ì·¨ì•½ì ì´ ìˆëŠ” íŒ¨í‚¤ì§€ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.\n\n`;
              } else {
                reviewSummary += `âœ… **ì˜ì¡´ì„± ë³´ì•ˆ ì–‘í˜¸**\n\n`;
              }
            }
          }

          // ì¶”ì²œ ì‚¬í•­
          reviewSummary += `## ğŸ’¡ ì¶”ì²œ ì‚¬í•­\n\n`;
          
          if (!testsChanged && pythonChanged) {
            reviewSummary += `- ğŸ§ª **í…ŒìŠ¤íŠ¸ ì½”ë“œ ì¶”ê°€**: Python ì½”ë“œê°€ ë³€ê²½ë˜ì—ˆì§€ë§Œ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ìˆ˜ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. TDD ì›ì¹™ì— ë”°ë¼ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.\n`;
          }
          
          reviewSummary += `- ğŸ“– **ë¬¸ì„œ ì—…ë°ì´íŠ¸**: ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ë‚˜ ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\n`;
          reviewSummary += `- ğŸ”„ **ì½”ë“œ ë¦¬ë·°**: ë™ë£Œ ê°œë°œìì˜ ì½”ë“œ ë¦¬ë·°ë¥¼ ë°›ì•„ë³´ì„¸ìš”.\n`;
          reviewSummary += `- ğŸ—ï¸ **SOLID ì›ì¹™**: ì½”ë“œê°€ SOLID ì›ì¹™ì„ ì¤€ìˆ˜í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.\n`;
          reviewSummary += `- ğŸ§¹ **Clean Architecture**: Clean Architecture íŒ¨í„´ì„ ë”°ë¥´ê³  ìˆëŠ”ì§€ ê²€í† í•´ì£¼ì„¸ìš”.\n\n`;

          reviewSummary += `---\n`;
          reviewSummary += `ğŸ¤– ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒì„¸í•œ ë¦¬í¬íŠ¸ëŠ” Actions íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;

          if (existingReview) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingReview.id,
              body: reviewSummary
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: reviewSummary
            });
          }

    - name: ìƒì„¸ ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-review-reports
        path: |
          *_report.txt
          coverage.json 