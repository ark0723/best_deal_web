name: PR ìë™ ë¼ë²¨ë§

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ë³€ê²½ëœ íŒŒì¼ ë¶„ì„
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files_yaml: |
          backend:
            - 'backend/**'
            - '**/*api*'
          frontend:
            - 'frontend/**'
            - '**/*ui*'
            - '**/*component*'
          agent:
            - 'agent/**'
            - '**/*agent*'
          tests:
            - 'tests/**'
            - '**/*test*'
          docs:
            - 'docs/**'
            - '**/*.md'
            - '**/*.rst'
          config:
            - 'config.py'
            - '**/*config*'
            - '**/*.yml'
            - '**/*.yaml'
            - '.github/**'
          python:
            - '**/*.py'
          requirements:
            - 'requirements*.txt'
            - 'Pipfile*'
            - 'pyproject.toml'

    - name: PR ì œëª© ë° ì„¤ëª… ë¶„ì„
      id: pr-analysis
      uses: actions/github-script@v7
      with:
        script: |
          const title = '${{ github.event.pull_request.title }}';
          const body = '${{ github.event.pull_request.body }}' || '';
          const titleLower = title.toLowerCase();
          const bodyLower = body.toLowerCase();
          
          // íƒ€ì…ë³„ í‚¤ì›Œë“œ ë¶„ì„
          const typeKeywords = {
            'bug': ['fix', 'bug', 'error', 'issue', 'ë²„ê·¸', 'ìˆ˜ì •', 'ì˜¤ë¥˜'],
            'feature': ['feat', 'add', 'new', 'implement', 'ê¸°ëŠ¥', 'ì¶”ê°€', 'êµ¬í˜„'],
            'enhancement': ['improve', 'enhance', 'update', 'optimize', 'ê°œì„ ', 'í–¥ìƒ', 'ìµœì í™”'],
            'refactor': ['refactor', 'clean', 'restructure', 'ë¦¬íŒ©í† ë§', 'ì •ë¦¬', 'ì¬êµ¬ì„±'],
            'documentation': ['docs', 'document', 'readme', 'ë¬¸ì„œ'],
            'breaking-change': ['breaking', 'major', 'break', 'í˜¸í™˜ì„±'],
            'security': ['security', 'vulnerability', 'cve', 'ë³´ì•ˆ'],
            'performance': ['perf', 'performance', 'speed', 'fast', 'ì„±ëŠ¥', 'ì†ë„'],
            'hotfix': ['hotfix', 'urgent', 'critical', 'ê¸´ê¸‰', 'í•«í”½ìŠ¤']
          };
          
          // ìš°ì„ ìˆœìœ„ í‚¤ì›Œë“œ ë¶„ì„
          const priorityKeywords = {
            'priority: critical': ['critical', 'urgent', 'emergency', 'ê¸´ê¸‰', 'í¬ë¦¬í‹°ì»¬'],
            'priority: high': ['high', 'important', 'ë†’ìŒ', 'ì¤‘ìš”'],
            'priority: low': ['low', 'minor', 'trivial', 'ë‚®ìŒ', 'ì‚¬ì†Œ']
          };
          
          let detectedLabels = [];
          
          // íƒ€ì… ë¼ë²¨ ê²€ì¶œ
          for (const [label, keywords] of Object.entries(typeKeywords)) {
            if (keywords.some(keyword => titleLower.includes(keyword) || bodyLower.includes(keyword))) {
              detectedLabels.push(label);
            }
          }
          
          // ìš°ì„ ìˆœìœ„ ë¼ë²¨ ê²€ì¶œ
          for (const [label, keywords] of Object.entries(priorityKeywords)) {
            if (keywords.some(keyword => titleLower.includes(keyword) || bodyLower.includes(keyword))) {
              detectedLabels.push(label);
            }
          }
          
          return detectedLabels;

    - name: ë¼ë²¨ ëª©ë¡ êµ¬ì„±
      id: label-list
      uses: actions/github-script@v7
      with:
        script: |
          let labels = [];
          
          // ë³€ê²½ëœ íŒŒì¼ ê¸°ë°˜ ë¼ë²¨
          if ('${{ steps.changed-files.outputs.backend_any_changed }}' === 'true') {
            labels.push('area: backend');
          }
          if ('${{ steps.changed-files.outputs.frontend_any_changed }}' === 'true') {
            labels.push('area: frontend');
          }
          if ('${{ steps.changed-files.outputs.agent_any_changed }}' === 'true') {
            labels.push('area: agent');
          }
          if ('${{ steps.changed-files.outputs.tests_any_changed }}' === 'true') {
            labels.push('area: tests');
          }
          if ('${{ steps.changed-files.outputs.docs_any_changed }}' === 'true') {
            labels.push('area: documentation');
          }
          if ('${{ steps.changed-files.outputs.config_any_changed }}' === 'true') {
            labels.push('area: config');
          }
          if ('${{ steps.changed-files.outputs.requirements_any_changed }}' === 'true') {
            labels.push('dependencies');
          }
          
          // PR ë¶„ì„ ê¸°ë°˜ ë¼ë²¨ ì¶”ê°€
          const prLabels = ${{ steps.pr-analysis.outputs.result }};
          if (prLabels && prLabels.length > 0) {
            labels.push(...prLabels);
          }
          
          // ë³€ê²½ íŒŒì¼ ìˆ˜ì— ë”°ë¥¸ í¬ê¸° ë¼ë²¨
          const changedFilesList = '${{ steps.changed-files.outputs.all_changed_files }}';
          const fileCount = changedFilesList ? changedFilesList.split(' ').length : 0;
          
          if (fileCount <= 2) {
            labels.push('size: small');
          } else if (fileCount <= 10) {
            labels.push('size: medium');
          } else {
            labels.push('size: large');
          }
          
          // ë¸Œëœì¹˜ íŒ¨í„´ ê¸°ë°˜ ë¼ë²¨
          const headBranch = '${{ github.event.pull_request.head.ref }}';
          if (headBranch.startsWith('feature/')) {
            labels.push('type: feature');
          } else if (headBranch.startsWith('bugfix/') || headBranch.startsWith('fix/')) {
            labels.push('type: bugfix');
          } else if (headBranch.startsWith('hotfix/')) {
            labels.push('type: hotfix');
          } else if (headBranch.startsWith('refactor/')) {
            labels.push('type: refactor');
          }
          
          // ì¤‘ë³µ ì œê±°
          return [...new Set(labels)];

    - name: ë¼ë²¨ ìƒì„± (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë¼ë²¨ë“¤)
      uses: actions/github-script@v7
      with:
        script: |
          const labelsToCreate = [
            { name: 'area: backend', color: '0052cc', description: 'Backend related changes' },
            { name: 'area: frontend', color: '0e8a16', description: 'Frontend related changes' },
            { name: 'area: agent', color: 'd4c5f9', description: 'AI Agent related changes' },
            { name: 'area: tests', color: 'f9d0c4', description: 'Test related changes' },
            { name: 'area: documentation', color: '0075ca', description: 'Documentation changes' },
            { name: 'area: config', color: 'fef2c0', description: 'Configuration changes' },
            { name: 'dependencies', color: '0366d6', description: 'Dependency updates' },
            { name: 'size: small', color: 'c2e0c6', description: 'Small change (1-2 files)' },
            { name: 'size: medium', color: 'ffd33d', description: 'Medium change (3-10 files)' },
            { name: 'size: large', color: 'd73a4a', description: 'Large change (10+ files)' },
            { name: 'type: feature', color: '0e8a16', description: 'New feature' },
            { name: 'type: bugfix', color: 'd93f0b', description: 'Bug fix' },
            { name: 'type: hotfix', color: 'b60205', description: 'Hotfix' },
            { name: 'type: refactor', color: '5319e7', description: 'Code refactoring' },
            { name: 'bug', color: 'd73a4a', description: 'Bug report' },
            { name: 'feature', color: '0e8a16', description: 'New feature request' },
            { name: 'enhancement', color: 'a2eeef', description: 'Enhancement' },
            { name: 'refactor', color: '5319e7', description: 'Refactoring' },
            { name: 'documentation', color: '0075ca', description: 'Documentation' },
            { name: 'breaking-change', color: 'b60205', description: 'Breaking change' },
            { name: 'security', color: 'ee0701', description: 'Security issue' },
            { name: 'performance', color: 'fbca04', description: 'Performance improvement' },
            { name: 'hotfix', color: 'b60205', description: 'Hotfix' },
            { name: 'priority: critical', color: 'b60205', description: 'Critical priority' },
            { name: 'priority: high', color: 'd93f0b', description: 'High priority' },
            { name: 'priority: low', color: '0e8a16', description: 'Low priority' }
          ];

          // ê¸°ì¡´ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
          const { data: existingLabels } = await github.rest.issues.listLabelsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });

          const existingLabelNames = existingLabels.map(label => label.name);

          // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë¼ë²¨ë§Œ ìƒì„±
          for (const label of labelsToCreate) {
            if (!existingLabelNames.includes(label.name)) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`Created label: ${label.name}`);
              } catch (error) {
                console.log(`Failed to create label ${label.name}: ${error.message}`);
              }
            }
          }

    - name: ë¼ë²¨ ì ìš©
      uses: actions/github-script@v7
      with:
        script: |
          const labels = ${{ steps.label-list.outputs.result }};
          
          if (labels && labels.length > 0) {
            try {
              await github.rest.issues.setLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              
              console.log(`ì ìš©ëœ ë¼ë²¨: ${labels.join(', ')}`);
              
              // ë¼ë²¨ ì ìš© ì™„ë£Œ ëŒ“ê¸€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ğŸ·ï¸ **ìë™ ë¼ë²¨ë§ ì™„ë£Œ**\n\në‹¤ìŒ ë¼ë²¨ë“¤ì´ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤:\n${labels.map(label => `\`${label}\``).join(', ')}\n\në¼ë²¨ì€ ë³€ê²½ëœ íŒŒì¼ê³¼ PR ì œëª©/ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ìë™ìœ¼ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n---\nğŸ¤– ìë™ ë¼ë²¨ë§ ì‹œìŠ¤í…œ`
              });
            } catch (error) {
              console.log(`ë¼ë²¨ ì ìš© ì‹¤íŒ¨: ${error.message}`);
            }
          } 